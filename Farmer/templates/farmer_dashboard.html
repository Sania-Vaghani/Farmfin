{% extends "base.html" %}

{% block title %}Farmer Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2>Welcome, {{ current_user.username }}!</h2>
    </div>

    {% if not farm_data %}
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Submit Farm Data</h5>
                <form id="farmDataForm" method="POST" action="{{ url_for('submit_farm_data') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">Farm Location</label>
                            <input type="text" class="form-control" id="location" name="location" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="land_size" class="form-label">Land Size (hectares)</label>
                            <input type="number" step="0.01" class="form-control" id="land_size" name="land_size" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="soil_type" class="form-label">Soil Type</label>
                            <select class="form-select" id="soil_type" name="soil_type" required>
                                <option value="">Select soil type</option>
                                <option value="loam">Loam</option>
                                <option value="clay">Clay</option>
                                <option value="sandy">Sandy</option>
                                <option value="silt">Silt</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="crop_type" class="form-label">Primary Crop</label>
                            <select class="form-select" id="crop_type" name="crop_type" required>
                                <option value="">Select crop type</option>
                                <option value="wheat">Wheat</option>
                                <option value="rice">Rice</option>
                                <option value="corn">Corn</option>
                                <option value="soybean">Soybean</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="last_yield" class="form-label">Last Year's Yield (tons/hectare)</label>
                        <input type="number" step="0.01" class="form-control" id="last_yield" name="last_yield" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Submit Farm Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Farm Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <th>Location:</th>
                        <td>{{ farm_data.location }}</td>
                    </tr>
                    <tr>
                        <th>Land Size:</th>
                        <td>{{ farm_data.land_size }} hectares</td>
                    </tr>
                    <tr>
                        <th>Soil Type:</th>
                        <td>{{ farm_data.soil_type|title }}</td>
                    </tr>
                    <tr>
                        <th>Primary Crop:</th>
                        <td>{{ farm_data.crop_type|title }}</td>
                    </tr>
                    <tr>
                        <th>Last Yield:</th>
                        <td>{{ farm_data.last_yield }} tons/hectare</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        {% if credit_score %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Credit Score Analysis</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <h2 class="display-4">{{ credit_score.score }}</h2>
                    <p class="text-muted">Credit Score</p>
                </div>
                <h6>Factor Breakdown:</h6>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" style="width: 0%" data-width="{{ credit_score.weather_factor * 100 }}%">
                        Weather ({{ "%.0f"|format(credit_score.weather_factor * 100) }}%)
                    </div>
                </div>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" data-width="{{ credit_score.soil_factor * 100 }}%">
                        Soil ({{ "%.0f"|format(credit_score.soil_factor * 100) }}%)
                    </div>
                </div>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 0%" data-width="{{ credit_score.yield_factor * 100 }}%">
                        Yield ({{ "%.0f"|format(credit_score.yield_factor * 100) }}%)
                    </div>
                </div>
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" data-width="{{ credit_score.financial_factor * 100 }}%">
                        Financial ({{ "%.0f"|format(credit_score.financial_factor * 100) }}%)
                    </div>
                </div>
                <p class="text-muted mt-2">Last updated: {{ credit_score.calculated_at.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Credit Score</h5>
                <p>Your credit score is being calculated. Please check back soon.</p>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const farmDataForm = document.getElementById('farmDataForm');
    if (farmDataForm) {
        farmDataForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Form validation
            const location = document.getElementById('location').value.trim();
            const landSize = parseFloat(document.getElementById('land_size').value);
            const soilType = document.getElementById('soil_type').value;
            const cropType = document.getElementById('crop_type').value;
            const lastYield = parseFloat(document.getElementById('last_yield').value);

            if (!location || !landSize || !soilType || !cropType || !lastYield) {
                alert('Please fill in all fields');
                return;
            }

            if (landSize <= 0) {
                alert('Land size must be greater than 0');
                return;
            }

            if (lastYield < 0) {
                alert('Last yield cannot be negative');
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            const formData = new FormData(farmDataForm);

            // Submit form with CSRF token
            fetch(farmDataForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json'
                },
                credentials: 'same-origin',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.message) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    farmDataForm.insertAdjacentElement('beforebegin', alert);

                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    An error occurred while submitting the form.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                farmDataForm.insertAdjacentElement('beforebegin', alert);
            });
        });
    }

    // Animate progress bars
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const targetWidth = bar.getAttribute('data-width');
        setTimeout(() => {
            bar.style.width = targetWidth;
        }, 100);
    });
});
</script>
{% endblock %} 